stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

# ============================================================================
# STAGE 1 : BUILD â€” sur toutes les branches
# Construit les images Docker (api + nginx) et les push sur le registry GitLab
# ============================================================================
build-images:
  stage: build
  image: docker:25.0.5
  services:
    - docker:25.0.5-dind
  before_script:
    - apk add --no-cache bash
  script:
    - cd doodlestudent
    - chmod +x scripts/build.sh
    - ./scripts/build.sh
  rules:
    - if: $CI_COMMIT_BRANCH

# ============================================================================
# STAGE 2 : TEST â€” vÃ©rifications rapides (smoke test des images)
# ============================================================================
test-images:
  stage: test
  image: docker:25.0.5
  services:
    - docker:25.0.5-dind
  before_script:
    - apk add --no-cache bash curl
  script:
    - cd doodlestudent
    - |
      TAG="${CI_COMMIT_SHA}"
      API_IMAGE="$CI_REGISTRY_IMAGE/api:$TAG"
      NGINX_IMAGE="$CI_REGISTRY_IMAGE/nginx:$TAG"

      echo ">>> Login au registry..."
      printf '%s' "$CI_REGISTRY_PASSWORD" | docker login "$CI_REGISTRY" -u "$CI_REGISTRY_USER" --password-stdin

      echo ">>> Pull des images..."
      docker pull "$API_IMAGE"
      docker pull "$NGINX_IMAGE"

      echo ">>> VÃ©rification que l'image API dÃ©marre..."
      docker run --rm -d --name test-api -p 8080:8080 \
        -e QUARKUS_DATASOURCE_DB_KIND=h2 \
        -e QUARKUS_DATASOURCE_JDBC_URL="jdbc:h2:mem:test" \
        -e QUARKUS_HIBERNATE_ORM_DATABASE_GENERATION=drop-and-create \
        -e QUARKUS_MAILER_MOCK=true \
        "$API_IMAGE" || true

      echo ">>> VÃ©rification que l'image Nginx dÃ©marre..."
      docker run --rm -d --name test-nginx -p 8081:80 "$NGINX_IMAGE"
      sleep 5

      echo ">>> Smoke test Nginx..."
      curl -sf http://localhost:8081/ > /dev/null && echo "  âœ… Nginx OK" || echo "  âš ï¸ Nginx check failed (non-bloquant)"

      echo ">>> Nettoyage..."
      docker stop test-nginx 2>/dev/null || true
      docker stop test-api 2>/dev/null || true

      echo "âœ… Tests smoke passÃ©s"
  rules:
    - if: $CI_COMMIT_BRANCH

# ============================================================================
# STAGE 3 : DEPLOY â€” AUTOMATIQUE quand un merge arrive sur la branche 'deploy'
#
# ðŸŽ¯ Workflow pour le prof :
#   1. CrÃ©er une Merge Request depuis main â†’ deploy
#   2. Cliquer "Merge"
#   3. C'est tout ! Le dÃ©ploiement se fait automatiquement
# ============================================================================
deploy-auto:
  stage: deploy
  image: alpine:3.19
  before_script:
    - apk add --no-cache bash openssh-client
  script:
    - cd doodlestudent
    - chmod +x scripts/deploy.sh
    - ./scripts/deploy.sh
  environment:
    name: production
    url: https://$DOODLE_DOMAIN
  rules:
    # âœ… DÃ©ploiement AUTOMATIQUE sur merge dans la branche 'deploy'
    - if: '$CI_COMMIT_BRANCH == "deploy"'
      when: on_success

# ============================================================================
# DEPLOY MANUEL â€” disponible sur main pour les cas exceptionnels
# ============================================================================
deploy-manual:
  stage: deploy
  image: alpine:3.19
  before_script:
    - apk add --no-cache bash openssh-client
  script:
    - cd doodlestudent
    - chmod +x scripts/deploy.sh
    - ./scripts/deploy.sh
  environment:
    name: production
    url: https://$DOODLE_DOMAIN
  rules:
    # ðŸ”˜ Bouton manuel sur la branche 'main' uniquement
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
    - when: never
